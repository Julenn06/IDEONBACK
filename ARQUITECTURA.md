# ๐๏ธ Arquitectura del Backend IDEON

## Diagrama de Arquitectura Limpia

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         PRESENTACIรN                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ                    API Layer                              โ   โ
โ  โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ    โ   โ
โ  โ  โ Controllers โ  โ     DTOs      โ  โ SignalR Hub โ    โ   โ
โ  โ  โ             โ  โ               โ  โ             โ    โ   โ
โ  โ  โ - Users     โ  โ - Request     โ  โ PhotoClash  โ    โ   โ
โ  โ  โ - PhotoClashโ  โ - Response    โ  โ    Hub      โ    โ   โ
โ  โ  โ - PhotoSweepโ  โ               โ  โ             โ    โ   โ
โ  โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ    โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      LรGICA DE NEGOCIO                           โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ                  Application Layer                        โ   โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโโ        โ   โ
โ  โ  โ    Services        โ  โ    Utilities         โ        โ   โ
โ  โ  โ                    โ  โ                      โ        โ   โ
โ  โ  โ - PhotoClash       โ  โ - PhraseGenerator    โ        โ   โ
โ  โ  โ - PhotoSweep       โ  โ - CodeGenerator      โ        โ   โ
โ  โ  โ - User             โ  โ                      โ        โ   โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโโ        โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      ACCESO A DATOS                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ                 Infrastructure Layer                      โ   โ
โ  โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโ           โ   โ
โ  โ  โ  DbContext  โ  โ    Repositories          โ           โ   โ
โ  โ  โ             โ  โ                          โ           โ   โ
โ  โ  โ  IdeonDB    โ  โ - User                   โ           โ   โ
โ  โ  โ  Context    โ  โ - Photo                  โ           โ   โ
โ  โ  โ             โ  โ - Room                   โ           โ   โ
โ  โ  โ  (EF Core)  โ  โ - RoomPlayer             โ           โ   โ
โ  โ  โ             โ  โ - Round                  โ           โ   โ
โ  โ  โ             โ  โ - RoundPhoto             โ           โ   โ
โ  โ  โ             โ  โ - Vote                   โ           โ   โ
โ  โ  โ             โ  โ - MatchResult            โ           โ   โ
โ  โ  โ             โ  โ - AppSettings            โ           โ   โ
โ  โ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโ           โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         DOMINIO                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ                    Domain Layer                           โ   โ
โ  โ  โโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโ      โ   โ
โ  โ  โ   Entities     โ  โ Interfaces  โ  โ  Enums   โ      โ   โ
โ  โ  โ                โ  โ             โ  โ          โ      โ   โ
โ  โ  โ - User         โ  โ - IUserRepo โ  โ RoomStatusโ     โ   โ
โ  โ  โ - Photo        โ  โ - IPhotoRepoโ  โ          โ      โ   โ
โ  โ  โ - Room         โ  โ - IRoomRepo โ  โ          โ      โ   โ
โ  โ  โ - RoomPlayer   โ  โ - etc...    โ  โ          โ      โ   โ
โ  โ  โ - Round        โ  โ             โ  โ          โ      โ   โ
โ  โ  โ - RoundPhoto   โ  โ             โ  โ          โ      โ   โ
โ  โ  โ - Vote         โ  โ             โ  โ          โ      โ   โ
โ  โ  โ - MatchResult  โ  โ             โ  โ          โ      โ   โ
โ  โ  โ - AppSettings  โ  โ             โ  โ          โ      โ   โ
โ  โ  โโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโ  โโโโโโโโโโโโ      โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     BASE DE DATOS                                โ
โ                    PostgreSQL 15+                                โ
โ                      (ideon_db)                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## Flujo de Datos - PhotoClash

```
โโโโโโโโโโโโโโโโ
โ   Flutter    โ
โ   Client     โ
โโโโโโโโฌโโโโโโโโ
       โ HTTP Request
       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PhotoClashController                    โ
โ  POST /api/photoclash/rooms              โ
โโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
       โ
       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PhotoClashService                       โ
โ  - Validar datos                         โ
โ  - Generar cรณdigo รบnico                  โ
โ  - Aplicar lรณgica de negocio             โ
โโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
       โ
       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  RoomRepository                          โ
โ  - Crear sala en BD                      โ
โ  - Guardar jugador                       โ
โโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
       โ
       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  IdeonDbContext (EF Core)                โ
โ  - Mapear entidades                      โ
โ  - Ejecutar SQL                          โ
โโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
       โ
       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PostgreSQL                              โ
โ  INSERT INTO rooms ...                   โ
โ  INSERT INTO room_players ...            โ
โโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
       โ Success
       โ
       (Respuesta HTTP 200 + Room DTO)
       
       โ Paralelamente...
       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PhotoClashHub (SignalR)                 โ
โ  NotifyPlayerJoined(roomCode, user)      โ
โโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
       โ
       โ
โโโโโโโโโโโโโโโโ
โ   Flutter    โ โ PlayerJoined event
โ   Clients    โ
โโโโโโโโโโโโโโโโ
```

---

## Comunicaciรณn en Tiempo Real

```
โโโโโโโโโโโโโโโ                    โโโโโโโโโโโโโโโโ
โ  Player 1   โ                    โ  Player 2    โ
โ  (Flutter)  โ                    โ  (Flutter)   โ
โโโโโโโโฌโโโโโโโ                    โโโโโโโโฌโโโโโโโโ
       โ                                  โ
       โ  WebSocket Connection            โ
       โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโค
       โ              โ                   โ
       โ              โ                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         PhotoClashHub (SignalR)              โ
โ         /hubs/photoclash                     โ
โ                                              โ
โ  Groups:                                     โ
โ  - room_ABC123                               โ
โ    โโ Player1 (ConnectionId: xyz)           โ
โ    โโ Player2 (ConnectionId: abc)           โ
โ                                              โ
โ  Events Broadcasting:                        โ
โ  - RoundStarted    โ All in room             โ
โ  - TimerTick       โ All in room             โ
โ  - PhotoUploaded   โ All in room             โ
โ  - VotingStarted   โ All in room             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## Entidades y Relaciones

```
โโโโโโโโโโโโ       โโโโโโโโโโโโโโโ       โโโโโโโโโโโโ
โ   User   โโโโโโโ<โ RoomPlayer  โ>โโโโโโโ   Room   โ
โโโโโโฌโโโโโโ       โโโโโโโโฌโโโโโโโ       โโโโโโฌโโโโโโ
     โ                    โ                    โ
     โ                    โ                    โ
     โ                    โ                    โ
     โ             โโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโ
     โ             โ RoundPhoto  โ      โ   Round    โ
     โ             โโโโโโโโฌโโโโโโโ      โโโโโโโฌโโโโโโโ
     โ                    โ                    โ
     โ                    โโโโโโโโโโโโโโโโโโโโโโ
     โ                             โ
     โ                             โ
โโโโโโโโโโโโ                โโโโโโโโโโโโโโ
โ  Photo   โ                โ    Vote    โ
โ(PhotoSweep)               โโโโโโโโโโโโโโ
โโโโโโโโโโโโ
     โ
     โ
โโโโโโโโโโโโ
โAppSettingsโ
โโโโโโโโโโโโ

Relaciones:
- User 1:N Photos
- User 1:N RoomPlayers
- User 1:1 AppSettings
- Room 1:N RoomPlayers
- Room 1:N Rounds
- Room 1:1 MatchResult
- Round 1:N RoundPhotos
- Round 1:N Votes
- RoomPlayer 1:N RoundPhotos
- RoomPlayer 1:N Votes (as voter)
- RoomPlayer 1:N Votes (as voted)
```

---

## Inyecciรณn de Dependencias

```
Program.cs configura:

Services Container
โโโ Scoped (por request HTTP)
โ   โโโ IdeonDbContext
โ   โโโ IUserRepository โ UserRepository
โ   โโโ IPhotoRepository โ PhotoRepository
โ   โโโ IRoomRepository โ RoomRepository
โ   โโโ IRoomPlayerRepository โ RoomPlayerRepository
โ   โโโ IRoundRepository โ RoundRepository
โ   โโโ IRoundPhotoRepository โ RoundPhotoRepository
โ   โโโ IVoteRepository โ VoteRepository
โ   โโโ IMatchResultRepository โ MatchResultRepository
โ   โโโ IAppSettingsRepository โ AppSettingsRepository
โ   โโโ UserService
โ   โโโ PhotoClashService
โ   โโโ PhotoSweepService
โ
โโโ Singleton (toda la aplicaciรณn)
    โโโ PhraseGeneratorService
    โโโ RoomCodeGeneratorService

Controllers reciben servicios via constructor injection
```

---

## Seguridad y Validaciones

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Request Validation Pipeline           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  1. Model Validation (Data Annotations)โ
โ     - Required fields                  โ
โ     - String lengths                   โ
โ     - Data types                       โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  2. Business Logic Validation          โ
โ     - PhotoClashService                โ
โ       โข No self-voting                 โ
โ       โข One photo per round            โ
โ       โข One vote per round             โ
โ       โข Min 2 players to start         โ
โ       โข Rounds 1-20                    โ
โ       โข Seconds 1-300                  โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  3. Database Constraints               โ
โ     - UNIQUE constraints               โ
โ     - FOREIGN KEY constraints          โ
โ     - CHECK constraints                โ
โ       (voter_player_id <> voted_player_id)
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
           โ Success
```

---

## Manejo de Errores

```
Exception Handling Strategy:

try {
    // Business logic
} catch (InvalidOperationException) {
    return BadRequest(new { error = "..." });
} catch (ArgumentException) {
    return BadRequest(new { error = "..." });
} catch (Exception) {
    return StatusCode(500, new { error = "Internal error" });
}

Tipos de respuestas:
- 200 OK           โ Operaciรณn exitosa
- 400 Bad Request  โ Error de validaciรณn
- 404 Not Found    โ Recurso no encontrado
- 500 Internal     โ Error del servidor
```

---

## Performance y Optimizaciรณn

```
Estrategias implementadas:

1. Async/Await
   - Todas las operaciones son asรญncronas
   - No bloquea threads del servidor

2. Lazy Loading Deshabilitado
   - Se usa .Include() explรญcitamente
   - Evita N+1 queries

3. Proyecciones con Select
   - Solo se traen campos necesarios
   - Menos datos transferidos

4. รndices en BD
   - idx_photos_user
   - idx_room_players_room
   - idx_round_photos_round
   - idx_votes_round

5. Connection Pooling
   - Configurado en PostgreSQL provider
   - Reutilizaciรณn de conexiones
```

---

## Escalabilidad

```
Preparado para:

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Horizontal Scaling                โ
โ                                    โ
โ  โโโโโโโโโโโ  โโโโโโโโโโโ         โ
โ  โ API 1   โ  โ API 2   โ         โ
โ  โโโโโโฌโโโโโ  โโโโโโฌโโโโโ         โ
โ       โ            โ               โ
โ       โโโโโโโโฌโโโโโโ               โ
โ              โ                     โ
โ      โโโโโโโโโโโโโโโโโ             โ
โ      โ Load Balancer โ             โ
โ      โโโโโโโโโโโโโโโโโ             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  SignalR Scale-Out                 โ
โ  (Redis Backplane - futuro)        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  PostgreSQL                        โ
โ  (Master-Replica setup)            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Actualmente: Configuraciรณn single-server
Futuro: Load balancing + Redis + DB replication
```

---

## Testing (Preparado para)

```
Estructura sugerida:

IdeonBack.Tests/
โโโ Unit/
โ   โโโ Services/
โ   โ   โโโ PhotoClashServiceTests.cs
โ   โ   โโโ PhotoSweepServiceTests.cs
โ   โ   โโโ UserServiceTests.cs
โ   โโโ Repositories/
โ       โโโ (mocks de repositorios)
โ
โโโ Integration/
โ   โโโ Controllers/
โ   โ   โโโ PhotoClashControllerTests.cs
โ   โ   โโโ PhotoSweepControllerTests.cs
โ   โโโ Database/
โ       โโโ DbContextTests.cs
โ
โโโ E2E/
    โโโ PhotoClashFlowTests.cs

Herramientas recomendadas:
- xUnit
- Moq (mocking)
- FluentAssertions
- TestContainers (PostgreSQL)
```

---

**Arquitectura diseรฑada para ser:**
- โ Mantenible
- โ Escalable  
- โ Testeable
- โ Profesional
